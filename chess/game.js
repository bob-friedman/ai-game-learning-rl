function engineGame(e){e=e||{};var t,n,o=new Chess,a=STOCKFISH(),i=null,r=!1,s={},l="white",u=!1;function c(e,t){console.log("UCI: "+e),(t||a).postMessage(e)}function m(){var e="Engine: ";if(engineStatus.engineLoaded?engineStatus.engineReady?e+="On.":e+="Loaded...":e+="Loading...",engineStatus.search&&(e+=" "+engineStatus.search.replace(/Depth: \d+ Nps: \d+/,"")),engineStatus.score&&r){var t=engineStatus.score;t.startsWith("Checkmate")||(t="Score: "+t),e+=" | "+t}var n="";o.game_over()?o.in_checkmate()?n="Checkmate!":o.in_stalemate()?n="Stalemate.":o.in_threefold_repetition()?n="Draw by Repetition.":o.insufficient_material()?n="Draw by Insufficient Material.":o.in_draw()&&(n="Draw."):o.in_check()&&(n="Check! ");var a="w"===o.turn()?"White":"Black",i=o.game_over()?"":a+" to move.";$("#engineStatus").html(e+" "+n+i)}function v(){$("#pgn").text(o.pgn()),setTimeout((function(){document.getElementById("pgn").scrollTop=9999})),t.position(o.fen()),m();var e="w"==o.turn()?"white":"black";o.game_over()||e!=l&&($('button[onclick="game.undo()"]').prop("disabled",!0),c("position fen "+o.fen()),c("go "+(s.movetime?"movetime "+s.movetime:"")),u=!0);try{if(o.game_over())localStorage.removeItem("savedChessGame");else{const e={fen:o.fen(),playerColor:l,skillLevel:s.level||0};localStorage.setItem("savedChessGame",JSON.stringify(e))}}catch(e){console.error("Could not save game to localStorage.",e)}}setInterval((function(){n||o.game_over()&&(n=!0)}),1e3),c("uci"),a.onmessage=function(t){var n;if(n=t&&"object"==typeof t?t.data:t,console.log("Reply: "+n),"uciok"==n)engineStatus.engineLoaded=!0,"function"==typeof e.onReady&&e.onReady();else if("readyok"==n)engineStatus.engineReady=!0;else{var a=n.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbn])?/);if(a){u=!1;var r={from:a[1],to:a[2],promotion:a[3]};if("function"==typeof i)return i(r),void(i=null);$('button[onclick="game.undo()"]').prop("disabled",!1),o.move(r),o.in_check()&&$("#engineStatus").text("Check!"),v()}else(a=n.match(/^info .*\bdepth (\d+) .*\bnps (\d+)/))&&(engineStatus.search="Depth: "+a[1]+" Nps: "+a[2]);if(a=n.match(/^info .*\bscore (\w+) (-?\d+)/)){var s=parseInt(a[2])*("w"==o.turn()?1:-1);"cp"==a[1]?engineStatus.score=(s/100).toFixed(2):"mate"==a[1]&&(engineStatus.score="Checkmate in "+Math.abs(s)),(a=n.match(/\b(upper|lower)bound\b/))&&(engineStatus.score=("upper"==a[1]==("w"==o.turn())?"<= ":">= ")+engineStatus.score),(a=n.match(/\bpv\s([a-h][1-8][a-h][1-8][qrbn]?)/))&&(engineStatus.pv=a[1])}}m()};var g={showErrors:!0,draggable:!0,position:"start",onDragStart:function(e,t,n,a){if(!0===o.game_over()||"w"===o.turn()&&"white"!==l||"b"===o.turn()&&"black"!==l)return!1},onDrop:function(e,t){var n={from:e,to:t,promotion:void 0},a=o.get(e);if(a&&"p"===a.type&&("w"===a.color&&"7"===e.charAt(1)&&"8"===t.charAt(1)||"b"===a.color&&"2"===e.charAt(1)&&"1"===t.charAt(1))&&(n.promotion=document.getElementById("promote").value),null===o.move(n))return"snapback";v()},onSnapEnd:function(){t.position(o.fen())}};return t=new ChessBoard("board",g),{reset:function(){o.reset(),localStorage.removeItem("savedChessGame"),c("setoption name Contempt value 0"),this.setSkillLevel(0)},loadPgn:function(e){o.load_pgn(e)},setPlayerColor:function(e){l=e,t.orientation(l)},setSkillLevel:function(e){var t;(e=parseInt(e))<0&&(e=0),e>20&&(e=20),s.level=e,s.movetime=500+200*e,c("setoption name Skill Level value "+e),t=Math.round(6.35*e+1),c("setoption name Skill Level Maximum Error value "+Math.round(-.5*e+10)),c("setoption name Skill Level Probability value "+t)},setDepth:function(e){s={depth:e}},setNodes:function(e){s={nodes:e}},setContempt:function(e){c("setoption name Contempt value "+e)},setAggressiveness:function(e){c("setoption name Aggressiveness value "+e)},setDisplayScore:function(e){r=e,m()},start:function(){c("ucinewgame"),c("isready"),engineStatus.engineReady=!1,engineStatus.search=null,m(),v(),n=!1},undo:function(){return 0!==o.history().length&&(!u&&(o.undo(),o.undo(),engineStatus.search=null,m(),v(),!0))},getFen:function(){var e=document.getElementById("fen");e&&(e.value=o.fen())},loadFen:function(){var e=document.getElementById("fen").value;if(o.load(e)){$("#pgn").text(o.pgn()),t.position(o.fen());var n="w"==o.turn()?"white":"black";o.game_over()||n!=l&&($('button[onclick="game.undo()"]').prop("disabled",!0),c("position fen "+o.fen()),c("go "+(s.movetime?"movetime "+s.movetime:"")),u=!0)}else $("#engineStatus").html("Invalid FEN string."),setTimeout((function(){m()}),4e3)},moveNotation:function(){var e=document.getElementById("moveNotation"),t=e.value.trim().toLowerCase();if(t){for(var n=o.moves(),a=null,i=0;i<n.length;i++){if(n[i].replace(/[+#=x]/g,"").toLowerCase()===t){a=n[i];break}}if(a&&o.move(a))v(),e.value="";else{var r=$("#engineStatus").html();$("#engineStatus").html("Invalid move: "+e.value.trim()),setTimeout((function(){$("#engineStatus").html(r)}),4e3)}}},resumeGame:function(e){c("isready"),o.load(e.fen),this.setPlayerColor(e.playerColor),this.setSkillLevel(e.skillLevel),t.position(o.fen()),$("#pgn").text(o.pgn()),setTimeout((function(){document.getElementById("pgn").scrollTop=9999}));var n="w"==o.turn()?"white":"black";o.game_over()||n!=l&&(c("position fen "+o.fen()),c("go "+(s.movetime?"movetime "+s.movetime:"")),u=!0),m()},loadPuzzle:function(e){o.reset(),o.load(e),t.position(e);var a="w"===o.turn()?"white":"black";this.setPlayerColor(a),$('input[name="playerColor"][value="'+a+'"]').prop("checked",!0),this.setSkillLevel(20),c("ucinewgame"),c("position fen "+e),$("#pgn").text(""),m(),n=!1},getCurrentFen:function(){return o.fen()},getBestMove:function(e,t){i=function(n){var o=new Chess(e).move(n);o&&t(o.san)},c("position fen "+e),c("go movetime 3000")}}}