const TILE_SIZE=42,MOVE_ANIM_MS=150,BOB_AMPLITUDE=2.5,BOB_FREQ=.014,PRE_RENDER_SCALE=3,canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),levelSelect=document.getElementById("levelSelect"),dpadButtons=document.querySelectorAll(".dbtn"),resetBtn=document.getElementById("resetBtn"),nextBtn=document.getElementById("nextBtn"),undoBtn=document.getElementById("undoBtn"),toggleDpadBtn=document.getElementById("toggleDpadBtn"),dpad=document.getElementById("dpad"),SPRITE_SVGS={floor:`<?xml version="1.0" encoding="utf-8"?><svg xmlns="http://www.w3.org/2000/svg" width="${TILE_SIZE}" height="${TILE_SIZE}" viewBox="0 0 ${TILE_SIZE} ${TILE_SIZE}"><rect width="${TILE_SIZE}" height="${TILE_SIZE}" fill="#a9a9a9"/><g fill="#9f9f9f"><rect x="0" y="0" width="${TILE_SIZE/2}" height="${TILE_SIZE/2}" opacity="0.25"/><rect x="${TILE_SIZE/2}" y="${TILE_SIZE/2}" width="${TILE_SIZE/2}" height="${TILE_SIZE/2}" opacity="0.25"/></g></svg>`,wall:`<?xml version="1.0" encoding="utf-8"?><svg xmlns="http://www.w3.org/2000/svg" width="${TILE_SIZE}" height="${TILE_SIZE}" viewBox="0 0 ${TILE_SIZE} ${TILE_SIZE}"><rect width="${TILE_SIZE}" height="${TILE_SIZE}" fill="#555"/><g fill="#666"><rect x="4" y="6" width="${TILE_SIZE-8}" height="${TILE_SIZE-12}" rx="6" ry="6"/></g><g stroke="#444" stroke-width="2" opacity="0.6"><line x1="4" y1="${TILE_SIZE/3}" x2="${TILE_SIZE-4}" y2="${TILE_SIZE/3}"/><line x1="4" y1="${2*TILE_SIZE/3}" x2="${TILE_SIZE-4}" y2="${2*TILE_SIZE/3}"/></g></svg>`,goal:`<?xml version="1.0" encoding="utf-8"?><svg xmlns="http://www.w3.org/2000/svg" width="${TILE_SIZE}" height="${TILE_SIZE}" viewBox="0 0 ${TILE_SIZE} ${TILE_SIZE}"><rect width="${TILE_SIZE}" height="${TILE_SIZE}" fill="transparent"/><circle cx="${TILE_SIZE/2}" cy="${TILE_SIZE/2}" r="${.22*TILE_SIZE+3}" fill="#c79a00"/>\n<circle cx="${TILE_SIZE/2}" cy="${TILE_SIZE/2}" r="${.22*TILE_SIZE}" fill="#ffd700"/></svg>`,box:`<?xml version="1.0" encoding="utf-8"?><svg xmlns="http://www.w3.org/2000/svg" width="${TILE_SIZE}" height="${TILE_SIZE}" viewBox="0 0 ${TILE_SIZE} ${TILE_SIZE}"><rect width="${TILE_SIZE}" height="${TILE_SIZE}" fill="transparent"/><rect x="6" y="8" width="${TILE_SIZE-12}" height="${TILE_SIZE-16}" rx="6" fill="#8b5a2b" stroke="#5a371d" stroke-width="2"/><rect x="10" y="12" width="${TILE_SIZE-20}" height="${TILE_SIZE-24}" rx="4" fill="#a26b3c" opacity="0.9"/><path d="M10 ${TILE_SIZE-12} L${TILE_SIZE-10} ${TILE_SIZE-12}" stroke="#5a371d" stroke-width="2"/></svg>`,player:`<?xml version="1.0" encoding="utf-8"?><svg xmlns="http://www.w3.org/2000/svg" width="${TILE_SIZE}" height="${TILE_SIZE}" viewBox="0 0 ${TILE_SIZE} ${TILE_SIZE}"><rect width="${TILE_SIZE}" height="${TILE_SIZE}" fill="transparent"/><circle cx="${TILE_SIZE/2}" cy="${TILE_SIZE/2-4}" r="${.26*TILE_SIZE+2}" fill="#1969b3"/>\n<circle cx="${TILE_SIZE/2}" cy="${TILE_SIZE/2-4}" r="${.26*TILE_SIZE}" fill="#1e90ff"/><circle cx="${TILE_SIZE/2-6}" cy="${TILE_SIZE/2-8}" r="3" fill="#fff"/><circle cx="${TILE_SIZE/2+6}" cy="${TILE_SIZE/2-8}" r="3" fill="#fff"/><circle cx="${TILE_SIZE/2-6}" cy="${TILE_SIZE/2-8}" r="1.1" fill="#000"/><circle cx="${TILE_SIZE/2+6}" cy="${TILE_SIZE/2-8}" r="1.1" fill="#000"/></svg>`},SPRITES={};function preRenderSprite(e){const t=document.createElement("canvas"),l=t.getContext("2d"),o=3*TILE_SIZE;return t.width=o,t.height=o,l.scale(3,3),e(l),t}async function loadAssets(){const e=document.createElement("canvas"),t=e.getContext("2d"),l=84;e.width=l,e.height=l,t.beginPath(),t.arc(42,34,25.84,0,2*Math.PI),t.fillStyle="#1969b3",t.fill(),t.beginPath(),t.arc(42,34,21.84,0,2*Math.PI),t.fillStyle="#1e90ff",t.fill(),t.beginPath(),t.arc(30,26,6,0,2*Math.PI),t.arc(54,26,6,0,2*Math.PI),t.fillStyle="#fff",t.fill(),t.beginPath(),t.arc(30,26,2.2,0,2*Math.PI),t.arc(54,26,2.2,0,2*Math.PI),t.fillStyle="#000",t.fill(),SPRITES.player=e;const o=document.createElement("canvas"),a=o.getContext("2d");o.width=l,o.height=l,a.beginPath(),a.arc(42,42,24.48,0,2*Math.PI),a.fillStyle="#c79a00",a.fill(),a.beginPath(),a.arc(42,42,18.48,0,2*Math.PI),a.fillStyle="#ffd700",a.fill(),SPRITES.goal=o;const n=["floor","wall","box"].map((e=>new Promise(((t,l)=>{const o=new Image;o.onload=()=>{SPRITES[e]=o,t()},o.onerror=()=>l(new Error(`Failed to load sprite: ${e}`)),o.src="data:image/svg+xml;base64,"+btoa(SPRITE_SVGS[e])}))));await Promise.all(n)}const levelSets=[{name:"Microban I",file:"levels/microban.txt"},{name:"Microban II",file:"levels/microban2.txt"},{name:"Microban III",file:"levels/microban3.txt"},{name:"Microban IV",file:"levels/microban4.txt"}];let currentSetIndex=0,levels=[],currentLevelIndex=0,board=[],width=0,height=0,player={x:0,y:0,px:0,py:0,moving:!1,from:null,to:null,moveStart:0,facing:{dx:0,dy:-1}},boxes=[],goals=[],undoStack=[],moves=0,touchStartX=0,touchStartY=0;const SWIPE_THRESHOLD=30;function parseSokobanLevels(e){const t=e.replace(/\r/g,"").split("\n"),l=[];let o="",a=[];const n=()=>{a.length>0&&l.push({name:o||`Level ${l.length+1}`,map:a})};for(const e of t){const t=e.trim();t.startsWith(";")?(n(),o=t.substring(1).trim(),a=[]):t.startsWith("'")&&t.endsWith("'")?o?o+=` - ${t.slice(1,-1)}`:o=t.slice(1,-1):t.length>0&&a.push(e)}return n(),l}function populateLevelSelect(){if(!levelSelect)return;levelSelect.innerHTML="";const e=document.createElement("optgroup");e.label="Actions",e.innerHTML='\n    <option value="next">Next Level</option>\n    <option value="reset">Reset Level</option>\n  ',levelSelect.appendChild(e);const t=document.createElement("optgroup");t.label="Levels",levels.forEach(((e,l)=>{const o=document.createElement("option");o.value=l,o.textContent=e.name||`Level ${l+1}`,t.appendChild(o)})),levelSelect.appendChild(t);const l=document.createElement("optgroup");l.label="Change Set",levelSets.forEach(((e,t)=>{const o=document.createElement("option");o.value=`set_${t}`,o.textContent=e.name,l.appendChild(o)})),levelSelect.appendChild(l)}function parseLevelMap(e){const t=e.length,l=Math.max(...e.map((e=>e.length))),o=[],a=[],n=[];let r=null;for(let c=0;c<t;c++){o[c]=[];const t=e[c]||"",i=t.trim();if(0===i.length){for(let e=0;e<l;e++)o[c][e]="#";continue}const I=t.indexOf(i),s=I+i.length-1;for(let e=0;e<l;e++){if(e<I||e>s){o[c][e]="#";continue}const l=t[e];switch(o[c][e]="#"===l?"#":" ",l){case"@":r={x:e,y:c,px:e*TILE_SIZE,py:c*TILE_SIZE,moving:!1,from:null,to:null,moveStart:0,facing:{dx:0,dy:-1}};break;case"$":a.push({x:e,y:c,px:e*TILE_SIZE,py:c*TILE_SIZE,moving:!1,from:null,to:null,moveStart:0});break;case".":n.push({x:e,y:c});break;case"+":r={x:e,y:c,px:e*TILE_SIZE,py:c*TILE_SIZE,moving:!1,from:null,to:null,moveStart:0,facing:{dx:0,dy:-1}},n.push({x:e,y:c});break;case"*":a.push({x:e,y:c,px:e*TILE_SIZE,py:c*TILE_SIZE,moving:!1,from:null,to:null,moveStart:0}),n.push({x:e,y:c})}}}return{board:o,boxes:a,goals:n,player:r,width:l,height:t}}function boxAt(e,t){return boxes.find((l=>l.x===e&&l.y===t))}function isWall(e,t){return t<0||t>=board.length||e<0||e>=(board[t]||[]).length||"#"===board[t][e]}function deepCopyStateForUndo(){return{player:{x:player.x,y:player.y,facing:{...player.facing}},boxes:boxes.map((e=>({x:e.x,y:e.y})))}}function restoreStateFromUndo(e){player.x=e.player.x,player.y=e.player.y,player.facing={...e.player.facing},player.moving=!1,player.px=player.x*TILE_SIZE,player.py=player.y*TILE_SIZE,boxes.forEach(((t,l)=>{t.x=e.boxes[l].x,t.y=e.boxes[l].y,t.moving=!1,t.px=t.x*TILE_SIZE,t.py=t.y*TILE_SIZE}))}function pushUndoState(){undoStack.push(deepCopyStateForUndo()),undoStack.length>200&&undoStack.shift()}function undoMove(){if(!undoStack.length)return;restoreStateFromUndo(undoStack.pop()),moves>0&&moves--}function tryMove(e,t){if(player.moving||isLevelComplete())return;const l=player.x+e,o=player.y+t;if(isWall(l,o))return;const a=boxAt(l,o);if(a){const n=a.x+e,r=a.y+t;if(isWall(n,r)||boxAt(n,r))return;pushUndoState(),startBoxMove(a,n,r),startPlayerMove(l,o,e,t),moves++}else pushUndoState(),startPlayerMove(l,o,e,t),moves++}function startPlayerMove(e,t,l,o){player.moving=!0,player.from={x:player.x,y:player.y},player.to={x:e,y:t},player.moveStart=performance.now(),player.x=e,player.y=t,player.facing={dx:l,dy:o}}function startBoxMove(e,t,l){e.moving=!0,e.from={x:e.x,y:e.y},e.to={x:t,y:l},e.moveStart=performance.now(),e.x=t,e.y=l}function ease(e){return e*e*(3-2*e)}function updateAnimations(){const e=performance.now();if(player.moving&&player.from&&player.to){const t=Math.min(1,(e-player.moveStart)/MOVE_ANIM_MS),l=ease(t);player.px=(player.from.x+(player.to.x-player.from.x)*l)*TILE_SIZE,player.py=(player.from.y+(player.to.y-player.from.y)*l)*TILE_SIZE,t>=1&&(player.moving=!1)}else player.px=player.x*TILE_SIZE,player.py=player.y*TILE_SIZE;boxes.forEach((t=>{if(t.moving&&t.from&&t.to){const l=Math.min(1,(e-t.moveStart)/MOVE_ANIM_MS),o=ease(l);t.px=(t.from.x+(t.to.x-t.from.x)*o)*TILE_SIZE,t.py=(t.from.y+(t.to.y-t.from.y)*o)*TILE_SIZE,l>=1&&(t.moving=!1)}else t.px=t.x*TILE_SIZE,t.py=t.y*TILE_SIZE}))}function drawBoard(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.imageSmoothingEnabled=!1;for(let e=0;e<height;e++)for(let t=0;t<width;t++){const l=t*TILE_SIZE,o=e*TILE_SIZE;isWall(t,e)?ctx.drawImage(SPRITES.wall,l,o,TILE_SIZE,TILE_SIZE):ctx.drawImage(SPRITES.floor,l,o,TILE_SIZE,TILE_SIZE)}ctx.imageSmoothingEnabled=!0,goals.forEach((e=>{ctx.drawImage(SPRITES.goal,e.x*TILE_SIZE,e.y*TILE_SIZE,TILE_SIZE,TILE_SIZE)})),ctx.imageSmoothingEnabled=!1,boxes.forEach((e=>{ctx.drawImage(SPRITES.box,e.px,e.py,TILE_SIZE,TILE_SIZE)}));let e=player.moving?Math.sin(performance.now()*BOB_FREQ)*BOB_AMPLITUDE:0;ctx.save(),ctx.translate(player.px+TILE_SIZE/2,player.py+TILE_SIZE/2+e);const t=player.facing;let l=0;1===t.dx?l=Math.PI/2:-1===t.dx?l=-Math.PI/2:1===t.dy&&(l=Math.PI),ctx.rotate(l),ctx.imageSmoothingEnabled=!0,ctx.drawImage(SPRITES.player,-TILE_SIZE/2,-TILE_SIZE/2,TILE_SIZE,TILE_SIZE),ctx.restore()}function isLevelComplete(){return!(!goals.length||!boxes.length)&&boxes.every((e=>goals.some((t=>t.x===e.x&&t.y===e.y))))}function loadLevel(e){if(!levels||!levels[e])return;currentLevelIndex=e;try{localStorage.setItem("boxes_lastSetIndex",currentSetIndex),localStorage.setItem("boxes_lastLevelIndex",e)}catch(e){console.error("Could not save level to localStorage.",e)}const t=parseLevelMap(levels[e].map);board=t.board,boxes=t.boxes,goals=t.goals,player=t.player||{x:0,y:0,px:0,py:0,moving:!1,from:null,to:null,moveStart:0,facing:{dx:0,dy:-1}},width=t.width,height=t.height,player.px=player.x*TILE_SIZE,player.py=player.y*TILE_SIZE,boxes.forEach((e=>{e.px=e.x*TILE_SIZE,e.py=e.y*TILE_SIZE,e.moving=!1})),undoStack=[],moves=0,levelSelect&&(levelSelect.value=String(e)),canvas.width=width*TILE_SIZE,canvas.height=height*TILE_SIZE}function loadNextLevel(){loadLevel((currentLevelIndex+1)%levels.length)}function handleKeyboard(e){const t=e.key.toLowerCase();"arrowup"===t||"w"===t?tryMove(0,-1):"arrowdown"===t||"s"===t?tryMove(0,1):"arrowleft"===t||"a"===t?tryMove(-1,0):"arrowright"===t||"d"===t?tryMove(1,0):"u"===t||"z"===t?undoMove():"r"===t&&confirm("Reset the level?")&&loadLevel(currentLevelIndex)}function handleTouchStart(e){e.preventDefault(),e.touches.length>0&&(touchStartX=e.touches[0].clientX,touchStartY=e.touches[0].clientY)}function handleTouchEnd(e){if(e.preventDefault(),0===touchStartX&&0===touchStartY)return;const t=e.changedTouches[0].clientX-touchStartX,l=e.changedTouches[0].clientY-touchStartY;touchStartX=0,touchStartY=0,Math.abs(t)>Math.abs(l)?t>30?tryMove(1,0):t<-30&&tryMove(-1,0):l>30?tryMove(0,1):l<-30&&tryMove(0,-1)}function loop(){updateAnimations(),drawBoard(),isLevelComplete()&&(ctx.fillStyle="rgba(0,0,0,0.45)",ctx.fillRect(0,canvas.height/2-28,canvas.width,56),ctx.fillStyle="#fff",ctx.font="20px Arial",ctx.textAlign="center",ctx.fillText("Level Complete!",canvas.width/2,canvas.height/2+6)),requestAnimationFrame(loop)}async function loadLevelSet(e,t=0){if(!levelSets[e])return;currentSetIndex=e;const l=levelSets[e].file;try{const e=await fetch(l);if(!e.ok)throw new Error(`Network response was not ok for ${l}`);const o=await e.text();if(levels=parseSokobanLevels(o),!levels.length)throw new Error(`No levels were parsed from ${l}.`);populateLevelSelect(),loadLevel(t)}catch(e){console.error("Could not fetch or parse level data:",e),levels=[{name:"Error: Load Failed",map:["#####","#.@.#","#.$.#","#...#","#####"]}],populateLevelSelect(),loadLevel(0)}}async function initializeGame(){let e=0,t=0;try{const l=localStorage.getItem("boxes_lastSetIndex"),o=localStorage.getItem("boxes_lastLevelIndex");if(null!==l){const a=parseInt(l,10);if(!isNaN(a)&&a>=0&&a<levelSets.length&&(e=a,null!==o)){const e=parseInt(o,10);isNaN(e)||(t=e)}}}catch(e){console.error("Could not load progress from localStorage.",e)}await loadLevelSet(e,t),requestAnimationFrame(loop)}async function main(){try{await loadAssets(),initializeGame()}catch(e){console.error("Failed to load assets. Game cannot start.",e)}}window.addEventListener("keydown",handleKeyboard),canvas.addEventListener("touchstart",handleTouchStart,{passive:!1}),canvas.addEventListener("touchend",handleTouchEnd,{passive:!1}),dpadButtons.forEach((e=>{e.addEventListener("pointerdown",(()=>{const t=e.dataset.dir;"up"===t?tryMove(0,-1):"down"===t?tryMove(0,1):"left"===t?tryMove(-1,0):"right"===t&&tryMove(1,0)}))})),resetBtn?.addEventListener("click",(()=>loadLevel(currentLevelIndex))),nextBtn?.addEventListener("click",(()=>loadNextLevel())),undoBtn?.addEventListener("click",(()=>undoMove())),levelSelect?.addEventListener("change",(e=>{const t=e.target.value;if(t.startsWith("set_")){const e=parseInt(t.split("_")[1],10);Number.isNaN(e)||loadLevelSet(e)}else if("next"===t)loadNextLevel();else if("reset"===t)loadLevel(currentLevelIndex);else{const e=parseInt(t,10);Number.isNaN(e)||loadLevel(e)}e.target.value=String(currentLevelIndex),e.target.blur()})),toggleDpadBtn?.addEventListener("click",(()=>{dpad?.classList.toggle("dpad-visible")})),main();